<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PerfSimPhp - Documentation</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* Doc Layout - Main + TOC Sidebar */
    .doc-layout {
      display: flex;
      gap: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    .doc-main {
      flex: 1;
      min-width: 0;
    }
    .docs-container {
      max-width: 900px;
      display: block;
      margin: 0;
      padding: 0;
    }
    .doc-toc {
      width: 280px;
      flex-shrink: 0;
    }
    .doc-toc-sticky {
      position: sticky;
      top: 80px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }
    .doc-toc-card {
      background: var(--color-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: 1.25rem;
    }
    .doc-toc-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--color-bg);
    }
    .doc-toc ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .doc-toc-item {
      margin-bottom: 0.25rem;
    }
    .doc-toc-item a {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      text-decoration: none;
      color: var(--color-text-muted);
      font-size: 0.875rem;
      transition: all var(--transition-fast);
      border-left: 2px solid transparent;
    }
    .doc-toc-item a:hover {
      background: rgba(92, 85, 152, 0.08);
      color: var(--color-primary);
      border-left-color: var(--color-primary);
    }
    .doc-toc-item a.active {
      background: rgba(92, 85, 152, 0.12);
      color: var(--color-primary);
      font-weight: 500;
      border-left-color: var(--color-primary);
    }
    .toc-icon {
      font-size: 1rem;
      width: 1.25rem;
      text-align: center;
      flex-shrink: 0;
    }
    .doc-toc-divider {
      height: 1px;
      background: var(--color-bg);
      margin: 0.75rem 0;
    }
    .doc-toc-section-label {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      padding: 0.5rem 0.75rem 0.25rem;
      opacity: 0.7;
    }

    /* Page Content Styles */
    .docs-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .docs-header h1 {
      color: var(--color-primary);
      margin-bottom: 0.5rem;
      font-size: 2rem;
    }
    .docs-header p {
      color: var(--color-text-muted);
      font-size: 1.1rem;
    }
    .docs-section {
      background: var(--color-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: 2rem;
      margin-bottom: 2rem;
      scroll-margin-top: 80px;
    }
    .docs-section h2 {
      color: var(--color-primary);
      border-bottom: 2px solid var(--color-bg);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }
    .docs-section h3 {
      color: var(--color-text);
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .docs-section p {
      margin-bottom: 1rem;
      color: var(--color-text-muted);
    }
    .docs-section ul, .docs-section ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }
    .docs-section li {
      margin-bottom: 0.5rem;
      color: var(--color-text-muted);
    }
    .docs-section code {
      background: #f6f8fa;
      padding: 0.2rem 0.4rem;
      border-radius: var(--radius-sm);
      font-family: 'Cascadia Code', 'Consolas', monospace;
      font-size: 0.875em;
      color: var(--color-danger);
    }
    .docs-section pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: var(--radius-md);
      overflow-x: auto;
      margin: 1rem 0;
      font-family: 'Cascadia Code', 'Consolas', monospace;
      font-size: 0.875rem;
      line-height: 1.6;
    }
    .docs-section pre code {
      background: none;
      padding: 0;
      color: inherit;
    }
    .warning-box {
      background: linear-gradient(135deg, rgba(255, 185, 0, 0.15) 0%, rgba(209, 52, 56, 0.1) 100%);
      border-left: 4px solid var(--color-warning);
      padding: 1rem 1.5rem;
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
      margin: 1.5rem 0;
    }
    .warning-box p { margin: 0; color: var(--color-text); }
    .info-box {
      background: rgba(0, 120, 212, 0.1);
      border-left: 4px solid var(--color-cpu);
      padding: 1rem 1.5rem;
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
      margin: 1.5rem 0;
    }
    .info-box p { margin: 0; color: var(--color-text); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid var(--color-bg);
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background: var(--color-bg);
      font-weight: 600;
      color: var(--color-text);
    }

    @media (max-width: 1024px) {
      .doc-layout {
        flex-direction: column;
      }
      .doc-toc {
        width: 100%;
        order: -1;
      }
      .doc-toc-sticky {
        position: relative;
        top: 0;
        max-height: none;
      }
      .doc-toc ul {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .doc-toc-item {
        margin-bottom: 0;
      }
      .doc-toc-item a {
        padding: 0.375rem 0.625rem;
        border-left: none;
        border-radius: var(--radius-md);
        background: var(--color-bg);
      }
      .doc-toc-divider,
      .doc-toc-section-label {
        display: none;
      }
    }
    @media (max-width: 768px) {
      .doc-layout {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <button id="hamburger-btn" class="hamburger-btn attention" aria-label="Open navigation menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <h1>&#x1F418; Performance Problem Simulator - PHP Blessed Image (PHP|8.4)</h1>
    <span id="sku-badge" class="sku-badge">SKU: Local</span>
    <nav>
      <a href="/" class="btn-panel-toggle">&#x1F3AE; Dashboard</a>
    </nav>
  </header>

  <!-- Sidebar Drawer Navigation -->
  <div id="sidebar-overlay" class="sidebar-overlay"></div>
  <aside id="sidebar-drawer" class="sidebar-drawer">
    <div class="sidebar-header">
      <h2>&#x1F418; PerfSimPhp</h2>
      <button id="sidebar-close" class="sidebar-close" aria-label="Close navigation">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <div class="sidebar-section-label">Application</div>
      <a href="/" class="sidebar-nav-item">
        <span class="nav-icon">&#x1F3AE;</span>
        <span class="nav-label">Dashboard<span class="nav-desc">Live metrics &amp; controls</span></span>
      </a>
      <div class="sidebar-divider"></div>
      <div class="sidebar-section-label">Documentation</div>
      <a href="/docs.html" class="sidebar-nav-item active">
        <span class="nav-icon">&#x1F4DA;</span>
        <span class="nav-label">Documentation<span class="nav-desc">API reference &amp; guides</span></span>
      </a>
      <a href="/azure-diagnostics.html" class="sidebar-nav-item">
        <span class="nav-icon">&#x2601;&#xFE0F;</span>
        <span class="nav-label">Azure Diagnostics<span class="nav-desc">Diagnose issues in App Service</span></span>
      </a>
      <a href="/azure-deployment.html" class="sidebar-nav-item">
        <span class="nav-icon">&#x1F680;</span>
        <span class="nav-label">Deploy to Azure<span class="nav-desc">GitHub Actions + OIDC setup</span></span>
      </a>
      <div class="sidebar-divider"></div>
      <div class="sidebar-section-label">External</div>
      <a href="https://github.com/rhamlett/perfsimphp" target="_blank" class="sidebar-nav-item">
        <span class="nav-icon">&#x1F419;</span>
        <span class="nav-label">GitHub Repository<span class="nav-desc">Source code &amp; issues</span></span>
      </a>
    </nav>
    <div class="sidebar-footer">
      PerfSimPhp v1.0 &bull; PHP 8.4
    </div>
  </aside>

  <div class="doc-layout">
    <div class="doc-main">
    <main class="docs-container">
    <div class="docs-header">
      <h1>&#x1F4DA; Documentation</h1>
      <p>Complete API reference and guides for PerfSimPhp performance simulation tools</p>
    </div>

    <section id="overview" class="docs-section">
      <h2>Overview</h2>
      <p>PerfSimPhp is an educational tool designed to help Azure support engineers practice diagnosing common PHP performance problems on Azure App Service. It intentionally generates controllable performance issues that mimic real-world scenarios.</p>
      
      <h3>Features</h3>
      <ul>
        <li><strong>CPU Stress</strong> &mdash; Generate high CPU usage at configurable percentages</li>
        <li><strong>Memory Pressure</strong> &mdash; Allocate and retain memory to simulate leaks</li>
        <li><strong>Request Thread Blocking</strong> &mdash; Block PHP-FPM workers with synchronous operations</li>
        <li><strong>Crash Simulation</strong> &mdash; Trigger fatal errors, exit, or OOM conditions</li>
      </ul>

      <h3>Architecture</h3>
      <p>The application runs on PHP 8.4 with Nginx + PHP-FPM, using APCu or file-based shared storage for cross-request state, and AJAX polling for real-time metrics.</p>
      <pre><code>public/
&#x251C;&#x2500;&#x2500; index.php               # Front controller (all requests)
&#x251C;&#x2500;&#x2500; index.html              # Main dashboard
&#x251C;&#x2500;&#x2500; docs.html               # Documentation
&#x251C;&#x2500;&#x2500; azure-diagnostics.html  # Diagnostics guide
&#x251C;&#x2500;&#x2500; azure-deployment.html   # Deployment guide
&#x251C;&#x2500;&#x2500; css/styles.css          # Shared stylesheet
&#x2514;&#x2500;&#x2500; js/
    &#x251C;&#x2500;&#x2500; polling-client.js   # AJAX polling client
    &#x251C;&#x2500;&#x2500; charts.js           # Real-time Chart.js charts
    &#x2514;&#x2500;&#x2500; dashboard.js        # UI interactions

src/
&#x251C;&#x2500;&#x2500; bootstrap.php           # Autoloader &amp; initialization
&#x251C;&#x2500;&#x2500; Config.php              # Application configuration
&#x251C;&#x2500;&#x2500; SharedStorage.php       # Cross-request state (APCu or file)
&#x251C;&#x2500;&#x2500; Router.php              # URL routing
&#x251C;&#x2500;&#x2500; Utils.php               # Utility functions
&#x251C;&#x2500;&#x2500; Middleware/
&#x2502;   &#x251C;&#x2500;&#x2500; ErrorHandler.php    # Error handling
&#x2502;   &#x251C;&#x2500;&#x2500; RequestLogger.php   # Request logging
&#x2502;   &#x2514;&#x2500;&#x2500; Validation.php      # Input validation
&#x251C;&#x2500;&#x2500; Services/
&#x2502;   &#x251C;&#x2500;&#x2500; CpuStressService.php      # Background CPU workers via exec()
&#x2502;   &#x251C;&#x2500;&#x2500; MemoryPressureService.php # Shared storage memory allocation
&#x2502;   &#x251C;&#x2500;&#x2500; BlockingService.php       # FPM worker pool blocking
&#x2502;   &#x251C;&#x2500;&#x2500; CrashService.php          # Worker crash triggers
&#x2502;   &#x251C;&#x2500;&#x2500; MetricsService.php        # System metrics collection
&#x2502;   &#x2514;&#x2500;&#x2500; EventLogService.php       # Event ring buffer
&#x2514;&#x2500;&#x2500; Controllers/
    &#x251C;&#x2500;&#x2500; HealthController.php
    &#x251C;&#x2500;&#x2500; MetricsController.php
    &#x251C;&#x2500;&#x2500; CpuController.php
    &#x251C;&#x2500;&#x2500; MemoryController.php
    &#x251C;&#x2500;&#x2500; BlockingController.php
    &#x251C;&#x2500;&#x2500; CrashController.php
    &#x2514;&#x2500;&#x2500; AdminController.php</code></pre>
    </section>

    <section id="cpu-stress" class="docs-section">
      <h2>CPU Stress Simulation</h2>
      <p>Generates high CPU usage using separate background processes via <code>exec()</code>.</p>

      <h3>How It Works</h3>
      <p>Spawns separate PHP CLI processes that run <code>hash_pbkdf2()</code> in a tight loop. The OS scheduler distributes these processes across CPU cores.</p>
      
      <div class="info-box">
        <p><strong>&#x1F4A1; PHP Insight:</strong> CPU-intensive work runs in separate processes to avoid blocking PHP-FPM workers. This allows the dashboard to remain responsive during CPU stress tests.</p>
      </div>

      <h3>Usage</h3>
      <pre><code>POST /api/simulations/cpu
Content-Type: application/json

{
  "intensity": "high",
  "durationSeconds": 30
}</code></pre>

      <h3>Parameters</h3>
      <table>
        <tr><th>Parameter</th><th>Values</th><th>Description</th></tr>
        <tr><td>intensity</td><td>"moderate" | "high"</td><td>CPU stress intensity level</td></tr>
        <tr><td>durationSeconds</td><td>1-300</td><td>How long to run the simulation</td></tr>
      </table>

      <h3>Expected Effects</h3>
      <ul>
        <li>CPU tile/chart increases to target percentage</li>
        <li>FPM workers stay low (work is in separate processes)</li>
        <li>Request latency may increase slightly due to CPU contention</li>
        <li>Multiple <code>php</code> processes visible in <code>top</code>/<code>htop</code></li>
      </ul>

      <h3>Diagnostic Tools</h3>
      <ul>
        <li><code>top</code> / <code>htop</code> - View all PHP processes</li>
        <li><code>ps aux | grep php</code> - See process tree</li>
        <li>Azure App Service Diagnostics &rarr; CPU drill-down</li>
        <li>Application Insights &rarr; Performance metrics</li>
      </ul>
    </section>

    <section id="memory-pressure" class="docs-section">
      <h2>Memory Pressure Simulation</h2>
      <p>Allocates and retains memory in APCu shared storage to simulate memory leaks.</p>

      <h3>How It Works</h3>
      <p>Uses APCu shared memory to store buffers that persist across requests. Multiple allocations can coexist (stacking behavior).</p>

      <div class="info-box">
        <p><strong>&#x1F4A1; PHP Insight:</strong> Unlike Node.js, PHP processes are stateless. To persist memory allocations across requests, we use APCu shared memory which is visible to all FPM workers.</p>
      </div>

      <h3>Usage</h3>
      <pre><code># Allocate memory
POST /api/simulations/memory
{"sizeMb": 100}

# Release memory (use the returned ID)
DELETE /api/simulations/memory/{id}</code></pre>

      <h3>Parameters</h3>
      <table>
        <tr><th>Parameter</th><th>Range</th><th>Description</th></tr>
        <tr><td>sizeMb</td><td>1-500</td><td>Memory to allocate in megabytes</td></tr>
      </table>

      <h3>Expected Effects</h3>
      <ul>
        <li>Memory metric increases by allocation size</li>
        <li>APCu shared memory fills up</li>
        <li>Worker memory (RSS) increases proportionally</li>
      </ul>

      <h3>Diagnostic Tools</h3>
      <ul>
        <li>Azure App Service &rarr; Memory metrics</li>
        <li><code>cat /proc/meminfo</code> - System memory stats</li>
        <li>APCu info via <code>apcu_cache_info()</code></li>
      </ul>
    </section>

    <section id="request-thread-blocking" class="docs-section">
      <h2>Request Thread Blocking Simulation</h2>
      <p>Demonstrates how synchronous operations block PHP-FPM workers, causing pool exhaustion.</p>

      <div class="warning-box">
        <p><strong>&#x26A0;&#xFE0F; Warning:</strong> During this simulation with enough concurrent requests, the FPM worker pool can become exhausted. New requests will queue until workers become available.</p>
      </div>

      <h3>How It Works</h3>
      <p>Performs synchronous <code>sleep()</code> calls directly in the FPM worker. Each blocked request holds a worker until complete.</p>

      <div class="info-box">
        <p><strong>&#x1F4A1; Key Difference from CPU Stress:</strong> CPU stress uses child processes (dashboard stays responsive). Request blocking runs in FPM workers (pool can be exhausted). Check the FPM Workers Busy metric to distinguish them!</p>
      </div>

      <h3>Usage</h3>
      <pre><code>POST /api/simulations/blocking
{"durationSeconds": 10, "workerCount": 4}</code></pre>

      <h3>Symptoms to Observe</h3>
      <ul>
        <li>FPM Workers Busy increases to match blocked workers</li>
        <li>Probe latency spikes when pool is exhausted</li>
        <li>New requests queue and complete together after unblock</li>
        <li>CPU stays relatively low (just waiting)</li>
      </ul>

      <h3>Diagnostic Tools</h3>
      <ul>
        <li>Azure App Service Diagnostics &rarr; PHP tab</li>
        <li><code>ps aux | grep php-fpm</code> - See worker states</li>
        <li>FPM status page (if enabled)</li>
      </ul>
    </section>

    <section id="crash-simulation" class="docs-section">
      <h2>Crash Simulation</h2>
      <p>Intentionally crashes PHP-FPM workers for testing crash recovery and observing restart behavior.</p>

      <div class="warning-box">
        <p><strong>&#x26A0;&#xFE0F; Warning:</strong> These operations will terminate the worker process. PHP-FPM automatically spawns replacement workers. Dashboard may briefly disconnect.</p>
      </div>

      <h3>Crash Types</h3>
      <table>
        <tr><th>Type</th><th>Endpoint</th><th>Method</th><th>Effect</th></tr>
        <tr><td>FailFast</td><td><code>/crash/failfast</code></td><td><code>exit(1)</code></td><td>Immediate process termination</td></tr>
        <tr><td>Fatal Error</td><td><code>/crash/fatal</code></td><td><code>trigger_error()</code></td><td>E_USER_ERROR with stack trace</td></tr>
        <tr><td>Exception</td><td><code>/crash/exception</code></td><td><code>throw Exception</code></td><td>Uncaught exception terminates</td></tr>
        <tr><td>OOM</td><td><code>/crash/memory</code></td><td>Infinite allocation</td><td>Memory exhaustion, OOM kill</td></tr>
      </table>

      <h3>Expected Behavior</h3>
      <ul>
        <li>Worker process terminates immediately</li>
        <li>PHP-FPM spawns a new worker (automatic)</li>
        <li>Event Log shows crash details and recovery</li>
        <li>Other requests continue (other workers unaffected)</li>
      </ul>

      <h3>Diagnostic Tools</h3>
      <ul>
        <li>Azure App Service &rarr; Diagnose and Solve Problems &rarr; Application Crashes</li>
        <li>Log Stream (real-time crash logs)</li>
        <li>Kudu &rarr; LogFiles &rarr; Application</li>
        <li>Application Insights &rarr; Failures blade</li>
      </ul>
    </section>

    <section id="diagnostics" class="docs-section">
      <h2>Diagnostics</h2>
      <p>For comprehensive guidance on diagnosing PHP performance issues, see the dedicated <a href="/azure-diagnostics.html"><strong>Azure Diagnostics Guide</strong></a>.</p>
      
      <h3>What's Covered</h3>
      <ul>
        <li><strong>Understanding Metrics</strong> - What CPU, memory, FPM workers, and latency metrics mean</li>
        <li><strong>Diagnostic Scenarios</strong> - Step-by-step walkthroughs for each simulation type</li>
        <li><strong>Azure Tools</strong> - App Service Diagnostics, Application Insights, Kudu console</li>
        <li><strong>Linux Tools</strong> - Process monitoring, PHP debugging, network analysis</li>
        <li><strong>KQL Queries</strong> - Ready-to-use queries for Azure diagnostics</li>
      </ul>
      
      <div class="info-box">
        <p><strong>&#x1F4A1; Tip:</strong> Open the <a href="/azure-diagnostics.html">Azure Diagnostics Guide</a> in a separate tab while running simulations to follow along with the diagnostic workflows.</p>
      </div>
    </section>

    <section id="api-reference" class="docs-section">
      <h2>API Reference</h2>
      
      <h3>Health &amp; Metrics</h3>
      <table>
        <tr><th>Endpoint</th><th>Method</th><th>Description</th></tr>
        <tr><td><code>/api/health</code></td><td>GET</td><td>Health check with uptime</td></tr>
        <tr><td><code>/api/metrics/probe</code></td><td>GET</td><td>Lightweight probe for latency monitoring</td></tr>
        <tr><td><code>/api/metrics</code></td><td>GET</td><td>Current system metrics (CPU, memory, FPM workers)</td></tr>
      </table>
      
      <h3>Simulations</h3>
      <table>
        <tr><th>Endpoint</th><th>Method</th><th>Description</th></tr>
        <tr><td><code>/api/simulations</code></td><td>GET</td><td>List all active simulations</td></tr>
        <tr><td><code>/api/simulations/cpu</code></td><td>POST</td><td>Start CPU stress (background processes)</td></tr>
        <tr><td><code>/api/simulations/cpu/:id</code></td><td>DELETE</td><td>Stop CPU stress</td></tr>
        <tr><td><code>/api/simulations/memory</code></td><td>POST</td><td>Allocate memory</td></tr>
        <tr><td><code>/api/simulations/memory/:id</code></td><td>DELETE</td><td>Release memory</td></tr>
        <tr><td><code>/api/simulations/blocking</code></td><td>POST</td><td>Block FPM workers</td></tr>
      </table>
      
      <h3>Crash Endpoints</h3>
      <table>
        <tr><th>Endpoint</th><th>Method</th><th>Crash Type</th></tr>
        <tr><td><code>/api/simulations/crash/failfast</code></td><td>POST</td><td>FailFast (exit)</td></tr>
        <tr><td><code>/api/simulations/crash/fatal</code></td><td>POST</td><td>Fatal error</td></tr>
        <tr><td><code>/api/simulations/crash/exception</code></td><td>POST</td><td>Uncaught exception</td></tr>
        <tr><td><code>/api/simulations/crash/memory</code></td><td>POST</td><td>Memory exhaustion</td></tr>
      </table>
      
      <h3>Admin</h3>
      <table>
        <tr><th>Endpoint</th><th>Method</th><th>Description</th></tr>
        <tr><td><code>/api/admin/status</code></td><td>GET</td><td>Admin status with configuration</td></tr>
        <tr><td><code>/api/admin/events</code></td><td>GET</td><td>Event log (limit via ?limit=N)</td></tr>
        <tr><td><code>/api/admin/system-info</code></td><td>GET</td><td>System info (CPUs, memory, SKU)</td></tr>
      </table>

      <h3>AJAX Polling</h3>
      <p>The dashboard uses AJAX polling instead of WebSockets:</p>
      <table>
        <tr><th>Endpoint</th><th>Frequency</th><th>Description</th></tr>
        <tr><td><code>/api/metrics</code></td><td>1000ms</td><td>System metrics (CPU, memory, FPM workers)</td></tr>
        <tr><td><code>/api/metrics/probe</code></td><td>250ms</td><td>Request latency measurements</td></tr>
        <tr><td><code>/api/admin/events</code></td><td>1000ms</td><td>Event log updates</td></tr>
        <tr><td><code>/api/simulations</code></td><td>1000ms</td><td>Active simulation states</td></tr>
      </table>
    </section>

    <section id="load-testing" class="docs-section">
      <h2>Azure Load Testing</h2>
      <p>PerfSimPhp includes a dedicated load testing endpoint designed for use with Azure Load Testing. This endpoint simulates realistic application behavior that degrades gracefully under load.</p>

      <h3>Load Test Endpoint</h3>
      <p>Unlike other simulation endpoints, this one does NOT appear in the dashboard UI and is meant for automated load testing scenarios only.</p>
      <table>
        <tr><th>Endpoint</th><th>Method</th><th>Description</th></tr>
        <tr><td><code>/api/loadtest</code></td><td>GET</td><td>Execute load test with query parameters</td></tr>
        <tr><td><code>/api/loadtest/stats</code></td><td>GET</td><td>Get current concurrent request statistics</td></tr>
      </table>

      <h3>Usage</h3>
      <p>Use the <code>GET /api/loadtest</code> endpoint directly in Azure Load Testing:</p>
      <pre><code># With defaults
https://your-app.azurewebsites.net/api/loadtest

# Custom parameters
https://your-app.azurewebsites.net/api/loadtest?workMs=500&amp;memoryKb=10000

# Memory only (no CPU work)
https://your-app.azurewebsites.net/api/loadtest?workMs=0&amp;memoryKb=100</code></pre>

      <h3>Query Parameters</h3>
      <table>
        <tr><th>Parameter</th><th>Default</th><th>Description</th></tr>
        <tr><td><code>workMs</code></td><td>100</td><td>CPU work duration per request (ms)</td></tr>
        <tr><td><code>memoryKb</code></td><td>10000</td><td>Memory buffer held for request duration (KB)</td></tr>
        <tr><td><code>holdMs</code></td><td>500</td><td>How long to hold memory after CPU work (ms)</td></tr>
      </table>

      <h3>What It Tests</h3>
      <ul>
        <li><strong>CPU</strong> &mdash; Real hash_pbkdf2() cryptographic work</li>
        <li><strong>Memory</strong> &mdash; Buffers allocated and held for request duration</li>
        <li><strong>FPM Workers</strong> &mdash; Worker utilization under concurrent load</li>
        <li><strong>Response Time</strong> &mdash; Increases naturally as requests queue</li>
      </ul>

      <div class="info-box">
        <p><strong>&#x1F4D8; Full Documentation:</strong> See the <a href="/azure-diagnostics.html#load-testing">Azure Diagnostics Guide</a> for detailed setup instructions, tuning scenarios, and diagnostic techniques.</p>
      </div>
    </section>

    </main>
    </div><!-- /.doc-main -->

    <!-- Right Sidebar Table of Contents -->
    <aside class="doc-toc">
      <div class="doc-toc-sticky">
        <nav class="doc-toc-card">
          <div class="doc-toc-title">On This Page</div>
          <ul>
            <li class="doc-toc-item">
              <a href="#overview"><span class="toc-icon">&#x1F4CB;</span>Overview</a>
            </li>
            <div class="doc-toc-divider"></div>
            <div class="doc-toc-section-label">Simulations</div>
            <li class="doc-toc-item">
              <a href="#cpu-stress"><span class="toc-icon">&#x1F525;</span>CPU Stress</a>
            </li>
            <li class="doc-toc-item">
              <a href="#memory-pressure"><span class="toc-icon">&#x1F4CA;</span>Memory Pressure</a>
            </li>
            <li class="doc-toc-item">
              <a href="#request-thread-blocking"><span class="toc-icon">&#x1F9F5;</span>Request Blocking</a>
            </li>
            <li class="doc-toc-item">
              <a href="#crash-simulation"><span class="toc-icon">&#x1F4A5;</span>Crash Simulation</a>
            </li>
            <div class="doc-toc-divider"></div>
            <div class="doc-toc-section-label">Reference</div>
            <li class="doc-toc-item">
              <a href="#diagnostics"><span class="toc-icon">&#x1F52C;</span>Diagnostics</a>
            </li>
            <li class="doc-toc-item">
              <a href="#api-reference"><span class="toc-icon">&#x1F4CB;</span>API Reference</a>
            </li>
            <li class="doc-toc-item">
              <a href="#load-testing"><span class="toc-icon">&#x1F4C8;</span>Azure Load Testing</a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
  </div><!-- /.doc-layout -->

  <footer>
    <p>Performance Problem Simulator &mdash; Educational Tool for Azure App Service Diagnostics</p>
    <p id="footer-credits"></p>
    <p id="build-info">Build: Loading...</p>
  </footer>
  <script>
    // Load environment info for SKU badge
    fetch('/api/health')
      .then(r => r.json())
      .then(data => {
        const badge = document.getElementById('sku-badge');
        if (badge && data.environment) badge.textContent = 'SKU: ' + (data.environment.sku || 'Local');
        // Load page footer from PAGE_FOOTER env var (allows HTML links)
        const footerCredits = document.getElementById('footer-credits');
        if (footerCredits) {
          if (data.pageFooter) {
            footerCredits.innerHTML = data.pageFooter;
          } else {
            footerCredits.style.display = 'none';
          }
        }
        const buildInfo = document.getElementById('build-info');
        if (buildInfo && data.buildTimestamp) {
          buildInfo.textContent = 'Build: ' + data.buildTimestamp;
        }
      })
      .catch(() => {});

    // Sidebar drawer toggle
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const sidebarDrawer = document.getElementById('sidebar-drawer');
    const sidebarClose = document.getElementById('sidebar-close');

    function openSidebar() {
      hamburgerBtn.classList.remove('attention');
      hamburgerBtn.classList.add('active');
      sidebarOverlay.classList.add('active');
      sidebarDrawer.classList.add('active');
    }

    function closeSidebar() {
      hamburgerBtn.classList.remove('active');
      sidebarOverlay.classList.remove('active');
      sidebarDrawer.classList.remove('active');
    }

    hamburgerBtn.addEventListener('click', openSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    sidebarClose.addEventListener('click', closeSidebar);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSidebar();
    });

    // Scroll-spy: highlight active section in right sidebar
    (function() {
      const tocLinks = document.querySelectorAll('.doc-toc-item a');
      const sections = document.querySelectorAll('.docs-section');

      function updateActiveTocLink() {
        const scrollPos = window.scrollY + 120;
        
        sections.forEach(section => {
          const sectionTop = section.offsetTop;
          const sectionHeight = section.offsetHeight;
          const sectionId = section.getAttribute('id');
          
          if (sectionId && scrollPos >= sectionTop && scrollPos < sectionTop + sectionHeight) {
            tocLinks.forEach(link => {
              link.classList.remove('active');
              if (link.getAttribute('href') === '#' + sectionId) {
                link.classList.add('active');
              }
            });
          }
        });
      }

      window.addEventListener('scroll', updateActiveTocLink);
      updateActiveTocLink(); // Initial call
    })();
  </script>
</body>
</html>
